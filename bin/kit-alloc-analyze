#! /usr/bin/perl
#
# When KIT_ALLOC_SET_LOG(1) is used in a debug build, this script analyzes
# output, looking for allocations not being freed.

use strict;
use warnings;
use Getopt::Std;

my %opts;
getopts('n', \%opts);     # -n to prepend line numbers (pipe thru sort -g to sort them)

my %mem;

for (my $line_number = 1; my $line = <>; $line_number++) {
    print $line if $line =~ m{kit_(?:free|realloc)\(0x([\da-f]+)[,)]} and not delete $mem{$1};
    $mem{$1} = ($opts{'n'} ? "$line_number:$line" : $line) if $line =~ m{0x([\da-f]+) = kit_((m|c|re)alloc|strdup)\(};
}

print for values %mem;
